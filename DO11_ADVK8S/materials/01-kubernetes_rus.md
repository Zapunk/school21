# Kubernetes

## Дистрибутивы Kubernetes

При настройке окружения Kubernetes существует два варианта: Vanilla Kubernetes и Managed Kubernetes. С Vanilla Kubernetes команда разработчиков программного обеспечения должна спуллить исходный код Kubernetes и скомпилировать окружение на машине. С другой стороны, Managed Kubernetes поставляется предварительно скомпилированным и предварительно настроенным, с наличием дополнительных инструментов, которые улучшают или добавляют новые функции в окружение Kubernetes, такие как хранение, безопасность, развертывание, мониторинг и т. д. Managed Kubernetes также известны как дистрибутивы Kubernetes.

Отдельная часть дистрибутивов Kubernetes разработана специально для того, чтобы задействовать меньшее количество ресурсов, например **Minikube** и **k3s**.

Два фактора — низкие требования к ресурсам и простота использования — делают облегченные дистрибутивы Kubernetes отличным выбором для людей, которые плохо знакомы с Kubernetes и хотят настроить среду на своем собственном компьютере, где они могут экспериментировать.

### Minikube

Minikube — это облегченный дистрибутив Kubernetes, разработанный в рамках основного проекта Kubernetes. Он может работать в Linux, Windows и macOS (хотя, если вы запускаете его вне среды Linux, он использует виртуализацию для настройки твоих кластеров; в Linux ты можешь использовать виртуализацию или запускать кластеры непосредственно на «голом железе»).

По умолчанию Minikube создает кластер из одного узла, но ты можешь настроить больше узлов, используя флаг `--nodes` при запуске Minikube.

Основные преимущества Minikube заключаются в том, что он чрезвычайно легкий и очень простой в установке и использовании.

Главным недостатком Minikube является то, что он предназначен только для тестирования. Это непрактичное решение для запуска кластеров производственного уровня.

### k3s

K3s — это облегченный дистрибутив Kubernetes, разработанный Rancher. Он также может работать в любой операционной системе (Linux, Windows и macOS).

Относительно легко настроить кластер с одним узлом. Ты просто загружаешь бинарный файл с GitHub и запускаешь одноузловой кластер командой:

`sudo server k3s`

Однако если ты хочешь добавить узлы в свой кластер, тебе нужно настроить k3s на них отдельно и присоединить их к своему кластеру. В этом отношении k3s немного сложнее в использовании, чем Minikube, который обеспечивает гораздо более простой процесс добавления узлов.

С другой стороны, k3s разработан как полноценный, готовый к производству дистрибутив Kubernetes, который также является легким. Rancher разработал его специально для вариантов использования, связанных с такими инфраструктурами, как Интернет вещей (IoT) и периферийные устройства.

## Создание собственного кластера k3s

Предлагаемый кластер будет состоять из 3 узлов: 2 воркера и 1 мастер-узел. Важно помнить, что при установке k3s на узлы воркеров системы требуется также передать адрес мастер-узла и специальный токен, подтверждающий доступ воркера к системе.

### Ingress контроллер

В системе k3s изначально предустановлен Ingress-контроллер для доступа к системе извне, однако не обязательно использовать именно его. Альтернативным решением может стать Nginx, в котором есть все необходимые инструменты для обеспечения доступности кластера.

Nginx Ingress контроллер уже существует в готовом виде, так как в случае использования стандартного Nginx логики перестраивания работы контроллера не будет и придется «вручную» изменять параметры для доступа к новым сервисам извне.

Следует отметить, что функционально принцип работы стандартного Ingress-контроллера от Nginx ничем не отличается, то есть конфигурирование компонент системы изменять не потребуется.

### Хранение данных PV, PVC

Persistent volumes — важная часть инфраструктуры системы всего Kubernetes. Она позволяет не только обеспечить гибкое управление хранилищами данных для сервисов, но и комфортным управлением с помощью PV-контроллера (PVC) — объем затрачиваемых ресурсов, права доступа, расширение и сужение используемого объема, а также настройка бэкапов с помощью разработанных решений от сообщества Kubernetes.

### Безопасность

Для обеспечения безопасности в первую очередь были разработаны инструменты, позволяющие создавать внутренние сети передачи данных, которые можно изолировать друг от друга. Основной задачей является не только защитить систему от сторонних злоумышленников, но и поддержать процесс разработки программного продукта системы с целью избежания использования «обходных путей» для доступа напрямую к опорным сервисам системы.

Как правило, сетевые ограничения устанавливаются на уровне namespace. То есть предлагается для каждого namespace выделять изолированную сеть, а уже потом некоторые компоненты системы делать доступными и в других сетях.

Помимо проблемы сетевого взаимодействия, возникла проблема администрирования данных доступа (токены, сертификаты, пароли). Опять же, кроме изоляции от рисков получения таких чувствительных данных злоумышленниками, существуют риски вмешательства изнутри. Так, во многих известных компаниях еще не так давно происходили кражи доступов к сторонним сервисам и недобросовестное использование полученных данных.

Kubernetes предложил также централизовать доступ к таким данным с помощью Secrets Management. Этот инструмент чем-то схож с принципом работы PV и PVC, однако не только предоставляет доступ к секретам, но и собирает информацию об их использовании, а также интегрирует процесс получения секрета в Deployment. Так, при развертывании сервиса, где секрет необходим, без полученного значения сервис не будет даже запущен.

### Cert-manager

Cert-manager — это утилита для автоматического управления сертификатами в Kubernetes. Он позволяет упростить и автоматизировать процесс генерации, выдачи и обновления сертификатов TLS (Transport Layer Security) в Kubernetes-кластере. Cert-manager поддерживает различные провайдеры сертификатов, включая Let's Encrypt, Venafi и HashiCorp Vault. Он может быть настроен для автоматической генерации сертификатов для приложений Kubernetes, основанных на ресурсах Kubernetes, таких как Ingress, и для автоматического обновления сертификатов при их истечении срока действия. Cert-manager также обеспечивает интеграцию с Kubernetes-оркестратором и его API, что облегчает управление сертификатами в Kubernetes.

### Операторы

Цель оператора — предоставить пользователю API, который позволяет управлять множеством сущностей stateful-приложения в кластере Kubernetes, не задумываясь о том, что у него под капотом (какие данные и что с ними делать, какие команды необходимо еще выполнить для поддержания кластера). Фактически оператор призван максимально упростить работу с приложением в рамках кластера, автоматизируя выполнение эксплуатационных задач, которые раньше приходилось решать вручную.

Например, оператор Prometheus обеспечивает собственное развертывание Kubernetes и управление Prometheus и связанными с ним компонентами мониторинга. Целью этого проекта является упрощение и автоматизация настройки стека мониторинга на базе Prometheus для кластеров Kubernetes.

То есть при необходимости автоматизированного деплоя многокомпонентного сервиса или стека нужно использовать операторы, которые самостоятельно будут отслеживать развертку и работу таких систем.
