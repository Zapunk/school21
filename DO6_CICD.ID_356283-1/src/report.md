## 1. Настройка gitlab-runner

1. Установка `gitlab-runner` на виртуальную машину

  ![Part1](img/part1.png)

2. Настройка `gitlab-runner`

  ![Part1_1](img/part1_1.png)

## 2. Сборка

1. Написание этапа CI по сборке приложения из папки `code-samples`

  ![Part2](img/part2.png)

2. Пушим и проверяем пайплайн

 ![Part2_1](img/part2_1.png)

## 3. Тест кодстайла

1. Этап для CI, который запускает скрипт кодстайла. А так же фейлит пайплайн, если тест завален и отображает в пайплайне вывод.  

  ![Part3](img/part3.png)

  Видим что пайплайн зафейлен 

  ![Part3_1](img/part3_1.png)

  Видим вывод в пайплайн кодстайла

  ![Part3_2](img/part3_2.png)

  ![Part3_3](img/part3_3.png)

2. Теперь исправляем кодстайл с помощью `clang-format -i --style=Google *.c` и все работает. 

  ![Part3_4](img/part3_4.png)

## 4. Интеграционные тесты

1. Добавляем тесты, и видим что тесты выводятся в пайплайн и если тест не проходит, то пайплайн фейлится. 

  ![Part4](img/part4.png)

  ![Part4_1](img/part4_1.png)

2. Поправляем тесты, что бы все заработало. 

  ![Part4_2](img/part4_2.png)

  ![Part4_3](img/part4_3.png)


## 5. Этап деплоя

1. Поднимаем вторую ВМ с помощью FULL COPY, настраиваем локальную сеть между ВМ

2. На ВМ1 настраиваем пользователя gitlab-runner, что бы раннер мог подключаться к ВМ2. 

  - Создаем пароль для пользователя gitlab-runner(изначально он не настроен) `sudo passwd gitlab-runner` проверяем `cat /etc/passwd | grep gitlab-runner` должно быть "...gitlab-runner:/bin/bash"

  - добавляем пользователя gitlab-runner группу sudo `sudo usermod -aG sudo gitlab-runner`

  - заходим под пользователем gitlab-runner `su - gitlab-runner`

  - на ВМ1 генерим ssh-ключ и с помощью `ssh-copy-id spectrav@10.10.0.2` копируем его на ВМ2

  - что бы раннер знал при первом подключении что ключ существует делаем `ssh-keyscan -p 22 10.10.0.2 >> ~/.ssh/known_hosts` проверяем `cat ~/.ssh/known_hosts` что добавлен второй ключ

  - на ВМ2 даем права директории `sudo chmod -R 777 /usr/local/bin`

3. Пишем этап диплой для CD

  ![Part5](img/part5.png)

4. Пишем скрипт для копирования артефактов на ВМ2

  ![Part5_1](img/part5_1.png)

5. Пушим, проверяем, диплой ждет запуска вручную

  ![Part5_2](img/part5_2.png)

запускаем... и все работает! Наслаждаемся и гуляем. 

  ![Part5_3](img/part5_3.png)

  ![Part5_4](img/part5_4.png)

## 6. Дополнительно. Уведомления

1. Через бот @BotFather создаем своего бота под своим ником и названием проекта. Получаем 'token'

2. Через бот @userinfobot узнаем свой ID

3. Из папки materials используем bash-скрипт `tgbot.sh`, меняем на свои данные token и ID

4. В раннере прописываем в каждый job `after_script` с запуском нашего скрипта `./src/tgbot.sh`

5. Пушим. Наслаждаемся и гуляем.  